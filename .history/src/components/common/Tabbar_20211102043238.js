import React, { Component } from "react";
import { TabBar } from "antd-mobile";
import { withRouter } from "react-router-dom";
import PubSub from "pubsub-js";
import io from 'socket.io-client'

class Tabbar extends Component {
  constructor(props) {
    super(props);
    this.state = {
      hidden: false,
      // 默认选中的TabBar菜单项
      selectedTab: this.props.location.pathname || "/home",
      isIndividual: this.props.location.pathname === '/individual' ? true : false,
      homeBadge: 0,
      friendBadge: 0
    };
  }

  componentDidMount(){
    this.props.getIsIndividual(this.state.isIndividual);
    PubSub.subscribe(`HIDE TABBAR`, (msg,data) => {
      this.setState({
        hidden : data
      })
    }) 

    // PubSub.subscribe(`INIT SELECTED`,(msg,data) => {
    //   this.setState({
    //     selectedTab : data
    //   })
    // })

    PubSub.subscribe("ADD BADGE", (msg, data) => {
      this.setState({
        homeBadge: data
      })
    })

    PubSub.subscribe("REDUCE BADGE", (msg, data) => {
      this.setState({
        homeBadge: this.state.homeBadge - data > 0 ? this.state.homeBadge - data : 0
      })
    })


    this.connSocket()
  }

  componentWillUnmount = () => {
    this.setState = (state,callback)=>{
      return;
    };
  }

  connSocket = () => {
    const socket = io.connect('ws://106.52.45.38:6050/home/chat')
    socket.emit("online",localStorage.getItem("userId"))
    // 接收信息改变badge
    socket.on("home-receive-message", () => {
      this.setState({
        homeBadge: this.state.homeBadge + 1
      })
    })

    // 已读消息减去badge
    // socket.on("reduce-tabbar-unread-badge", unread => {
    //   this.setState({
    //     homeBadge: this.state.homeBadge - unread
    //   })
    // })

    // 通讯录减去badge
    socket.on("cancel-addressbook-unread-badge", () => {
      this.setState({
        friendBadge: 0
      })
    })

    // 接收好友申请
    socket.on('receive-add', data => {
      this.setState({
        friendBadge: this.state.friendBadge + 1
      })
    })
  }

  render() {
    let self = this;
    return (
      <div style={{ position: "fixed", width: "100%", bottom: 0 }}>
        <TabBar
          unselectedTintColor="#949494"
          tintColor="#08C163"
          barTintColor="#F6F6F6"
          hidden={this.state.hidden}
        >
          <TabBar.Item
            title="微信"
            key="Wx"
            icon={
              <svg
                t="1627505545978"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="63909"
                width="25"
                height="25"
              >
                <path
                  d="M509.8 98.2c-220.2 0-398.7 156.2-398.7 348.9 0 110.1 58.5 208.2 149.5 272.1v176.5l174.7-106c24.2 4 49 6.3 74.5 6.3 220.2 0 398.7-156.2 398.7-348.9 0.1-192.7-178.4-348.9-398.7-348.9z"
                  p-id="63910"
                  fill="#dbdbdb"
                ></path>
              </svg>
            }
            selectedIcon={
              <svg
                t="1627505545978"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="63909"
                width="25"
                height="25"
              >
                <path
                  d="M509.8 98.2c-220.2 0-398.7 156.2-398.7 348.9 0 110.1 58.5 208.2 149.5 272.1v176.5l174.7-106c24.2 4 49 6.3 74.5 6.3 220.2 0 398.7-156.2 398.7-348.9 0.1-192.7-178.4-348.9-398.7-348.9z"
                  p-id="63910"
                  fill="#08C163"
                ></path>
              </svg>
            }
            selected={this.state.selectedTab === "/home"}
            badge={this.state.homeBadge}
            onPress={() => {
              this.setState(
                {
                  selectedTab: "/home",
                  isIndividual: false
                },
                () => {
                  self.props.history.push("/home");
                  self.props.getIsIndividual(this.state.isIndividual);
                }
              );
              PubSub.publish("CHANGE NAVBAR", ["微信", true]);
            }}
            data-seed="logId"
          ></TabBar.Item>
          <TabBar.Item
            icon={
              <svg
                t="1627505611748"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="65940"
                width="25"
                height="25"
              >
                <path
                  d="M711.602525 387.791094l215.391628 0c16.918321 0 29.658484 8.594749 29.658484 26.744107 0 18.154475-14.712073 26.749224-31.629371 26.749224L711.602525 441.284425c-16.925485 0-30.656207-8.594749-30.656207-26.749224C680.946318 396.384819 694.677041 387.791094 711.602525 387.791094z"
                  p-id="65941"
                  fill="#dbdbdb"
                ></path>
                <path
                  d="M956.088796 537.099654c0 18.151405-12.748349 26.752294-29.661553 26.752294L757.275751 563.851948c-16.925485 0-30.65723-8.597819-30.65723-26.752294 0-18.149359 13.731746-26.743084 30.65723-26.743084l170.132842 0C944.324868 510.35657 956.088796 518.950296 956.088796 537.099654z"
                  p-id="65942"
                  fill="#dbdbdb"
                ></path>
                <path
                  d="M800.847106 814.385958c0 39.784098-32.308847 64.12446-72.02643 64.12446L466.867592 878.510418l-84.297918 0-245.941412 0c-39.711444 0-72.024383-24.337291-72.024383-64.12446l0-17.287735c0-36.45426 26.839275-68.769246 61.099566-81.065294l146.643871-65.364707c0 0 39.749306-12.218276 50.631144-24.411993 7.239891-8.121981 9.473769-34.901905 0.296759-52.481282-9.174963-17.577331-83.47825-114.289999-83.47825-195.409528 0-130.822534 85.99149-236.876965 192.06127-236.876965 106.073874 0 192.058201 106.054431 192.058201 236.876965 0 84.695984-83.380012 177.934528-90.234117 200.878077-6.859221 22.943548-7.41283 40.902572 0.333598 48.523133 12.050454 11.843746 43.062771 23.88806 43.062771 23.88806l162.670893 63.391772c34.262338 12.301164 61.10059 45.601594 61.10059 82.055854L800.847106 814.385958 800.847106 814.385958z"
                  p-id="65943"
                  fill="#dbdbdb"
                ></path>
                <path
                  d="M926.918429 679.299307 813.853327 679.299307c-16.921391 0-30.653137-8.594749-30.653137-26.752294 0-18.147312 13.731746-26.743084 30.653137-26.743084l114.049522 0c16.921391 0 29.647227 8.594749 29.647227 26.743084C957.549054 670.701488 943.837774 679.299307 926.918429 679.299307z"
                  p-id="65944"
                  fill="#dbdbdb"
                ></path>
              </svg>
            }
            selectedIcon={
              <svg
                t="1627505611748"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="65940"
                width="25"
                height="25"
              >
                <path
                  d="M711.602525 387.791094l215.391628 0c16.918321 0 29.658484 8.594749 29.658484 26.744107 0 18.154475-14.712073 26.749224-31.629371 26.749224L711.602525 441.284425c-16.925485 0-30.656207-8.594749-30.656207-26.749224C680.946318 396.384819 694.677041 387.791094 711.602525 387.791094z"
                  p-id="65941"
                  fill="#08C163"
                ></path>
                <path
                  d="M956.088796 537.099654c0 18.151405-12.748349 26.752294-29.661553 26.752294L757.275751 563.851948c-16.925485 0-30.65723-8.597819-30.65723-26.752294 0-18.149359 13.731746-26.743084 30.65723-26.743084l170.132842 0C944.324868 510.35657 956.088796 518.950296 956.088796 537.099654z"
                  p-id="65942"
                  fill="#08C163"
                ></path>
                <path
                  d="M800.847106 814.385958c0 39.784098-32.308847 64.12446-72.02643 64.12446L466.867592 878.510418l-84.297918 0-245.941412 0c-39.711444 0-72.024383-24.337291-72.024383-64.12446l0-17.287735c0-36.45426 26.839275-68.769246 61.099566-81.065294l146.643871-65.364707c0 0 39.749306-12.218276 50.631144-24.411993 7.239891-8.121981 9.473769-34.901905 0.296759-52.481282-9.174963-17.577331-83.47825-114.289999-83.47825-195.409528 0-130.822534 85.99149-236.876965 192.06127-236.876965 106.073874 0 192.058201 106.054431 192.058201 236.876965 0 84.695984-83.380012 177.934528-90.234117 200.878077-6.859221 22.943548-7.41283 40.902572 0.333598 48.523133 12.050454 11.843746 43.062771 23.88806 43.062771 23.88806l162.670893 63.391772c34.262338 12.301164 61.10059 45.601594 61.10059 82.055854L800.847106 814.385958 800.847106 814.385958z"
                  p-id="65943"
                  fill="#08C163"
                ></path>
                <path
                  d="M926.918429 679.299307 813.853327 679.299307c-16.921391 0-30.653137-8.594749-30.653137-26.752294 0-18.147312 13.731746-26.743084 30.653137-26.743084l114.049522 0c16.921391 0 29.647227 8.594749 29.647227 26.743084C957.549054 670.701488 943.837774 679.299307 926.918429 679.299307z"
                  p-id="65944"
                  fill="#08C163"
                ></path>
              </svg>
            }
            title="通讯录"
            key="Friend"
            badge={this.state.friendBadge}
            selected={this.state.selectedTab === "/addressbook"}
            onPress={() => {
              this.setState(
                {
                  selectedTab: "/addressbook",
                  isIndividual: false
                },
                () => {
                  self.props.history.push("/addressbook");
                  self.props.getIsIndividual(this.state.isIndividual);
                }
              );
              PubSub.publish("CHANGE NAVBAR", ["通讯录", false]);
            }}
          ></TabBar.Item>
          <TabBar.Item
            icon={
              <svg
                t="1627505738851"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="67961"
                width="23"
                height="23"
              >
                <path
                  d="M870.057 358.26c-19.628-46.406-47.727-88.084-83.516-123.873-35.787-35.787-77.462-63.886-123.871-83.515-48.049-20.322-99.086-30.626-151.693-30.626-52.608 0-103.646 10.304-151.694 30.626C312.876 170.5 271.2 198.6 235.412 234.387c-35.79 35.79-63.888 77.466-83.515 123.873-20.322 48.048-30.627 99.084-30.627 151.693s10.305 103.647 30.627 151.695c19.628 46.406 47.725 88.082 83.515 123.873 35.789 35.789 77.465 63.887 123.87 83.514 48.05 20.322 99.087 30.627 151.695 30.627 52.609 0 103.646-10.304 151.694-30.627 46.407-19.628 88.082-47.726 123.872-83.514 35.789-35.79 63.887-77.466 83.514-123.873 20.323-48.048 30.627-99.085 30.627-151.695S890.38 406.307 870.057 358.26z m-136.13-43.04L591.66 582.042a20.773 20.773 0 0 1-8.593 8.592l-266.823 142.27a20.925 20.925 0 0 1-9.808 2.451 20.725 20.725 0 0 1-14.754-6.108c-6.536-6.537-8.005-16.408-3.655-24.564L430.29 437.858a20.782 20.782 0 0 1 8.592-8.592l266.823-142.264a20.93 20.93 0 0 1 9.808-2.453c5.572 0 10.812 2.17 14.754 6.107 6.535 6.536 8.006 16.407 3.66 24.563z"
                  fill="#dbdbdb"
                  p-id="67962"
                ></path>
                <path
                  d="M510.977 547.58c-9.904 0-19.6-4.016-26.606-11.02-7.005-7.006-11.021-16.704-11.021-26.607s4.016-19.6 11.02-26.606c7.005-7.004 16.703-11.02 26.607-11.02 9.905 0 19.602 4.016 26.606 11.02 7.004 7.004 11.02 16.702 11.02 26.606s-4.016 19.603-11.02 26.606c-7.004 7.005-16.702 11.021-26.606 11.021z"
                  fill="#dbdbdb"
                  p-id="67963"
                ></path>
              </svg>
            }
            selectedIcon={
              <svg
                t="1627505738851"
                className="icon"
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="67961"
                width="23"
                height="23"
              >
                <path
                  d="M870.057 358.26c-19.628-46.406-47.727-88.084-83.516-123.873-35.787-35.787-77.462-63.886-123.871-83.515-48.049-20.322-99.086-30.626-151.693-30.626-52.608 0-103.646 10.304-151.694 30.626C312.876 170.5 271.2 198.6 235.412 234.387c-35.79 35.79-63.888 77.466-83.515 123.873-20.322 48.048-30.627 99.084-30.627 151.693s10.305 103.647 30.627 151.695c19.628 46.406 47.725 88.082 83.515 123.873 35.789 35.789 77.465 63.887 123.87 83.514 48.05 20.322 99.087 30.627 151.695 30.627 52.609 0 103.646-10.304 151.694-30.627 46.407-19.628 88.082-47.726 123.872-83.514 35.789-35.79 63.887-77.466 83.514-123.873 20.323-48.048 30.627-99.085 30.627-151.695S890.38 406.307 870.057 358.26z m-136.13-43.04L591.66 582.042a20.773 20.773 0 0 1-8.593 8.592l-266.823 142.27a20.925 20.925 0 0 1-9.808 2.451 20.725 20.725 0 0 1-14.754-6.108c-6.536-6.537-8.005-16.408-3.655-24.564L430.29 437.858a20.782 20.782 0 0 1 8.592-8.592l266.823-142.264a20.93 20.93 0 0 1 9.808-2.453c5.572 0 10.812 2.17 14.754 6.107 6.535 6.536 8.006 16.407 3.66 24.563z"
                  fill="#08C163"
                  p-id="67962"
                ></path>
                <path
                  d="M510.977 547.58c-9.904 0-19.6-4.016-26.606-11.02-7.005-7.006-11.021-16.704-11.021-26.607s4.016-19.6 11.02-26.606c7.005-7.004 16.703-11.02 26.607-11.02 9.905 0 19.602 4.016 26.606 11.02 7.004 7.004 11.02 16.702 11.02 26.606s-4.016 19.603-11.02 26.606c-7.004 7.005-16.702 11.021-26.606 11.021z"
                  fill="#08C163"
                  p-id="67963"
                ></path>
              </svg>
            }
            title="发现"
            key="discover"
            // badge={"new"}
            selected={this.state.selectedTab === "/discover"}
            onPress={() => {
              this.setState(
                {
                  selectedTab: "/discover",
                  isIndividual: false
                },
                () => {
                  self.props.history.push("/discover");
                  self.props.getIsIndividual(this.state.isIndividual);
                }
              );
              PubSub.publish("CHANGE NAVBAR", ["发现", false]);
            }}
            data-seed="logId1"
          ></TabBar.Item>
          <TabBar.Item
            icon={
              <svg
                t="1627505779492"
                className="icon"
                viewBox="0 0 1025 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="69893"
                width="20"
                height="20"
              >
                <path
                  d="M2.327273 1010.036364c-2.327273-11.636364-2.327273-41.890909 0-74.472728 6.981818-58.181818 30.254545-100.072727 65.163636-125.672727 25.6-18.618182 58.181818-27.927273 86.109091-34.909091 13.963636-2.327273 27.927273-6.981818 39.563636-9.309091 69.818182-16.290909 141.963636-32.581818 195.490909-102.4 4.654545-4.654545 32.581818-46.545455-41.890909-137.309091-32.581818-39.563636-53.527273-93.090909-62.836363-160.581818-9.309091-69.818182-2.327273-134.981818 4.654545-176.872727 9.309091-48.872727 37.236364-93.090909 79.127273-125.672727 41.890909-32.581818 93.090909-48.872727 144.290909-48.872728s102.4 16.290909 144.290909 48.872728c41.890909 32.581818 69.818182 76.8 79.127273 128 6.981818 41.890909 13.963636 107.054545 4.654545 176.872727-9.309091 65.163636-30.254545 118.690909-62.836363 160.581818-74.472727 90.763636-44.218182 132.654545-41.890909 137.309091 53.527273 72.145455 125.672727 88.436364 195.490909 102.4 13.963636 2.327273 27.927273 6.981818 41.890909 9.309091 25.6 6.981818 58.181818 16.290909 83.781818 34.909091 76.8 53.527273 69.818182 169.890909 67.490909 197.818182H2.327273z"
                  p-id="69894"
                  fill="#dbdbdb"
                ></path>
              </svg>
            }
            selectedIcon={
              <svg
                t="1627505779492"
                className="icon"
                viewBox="0 0 1025 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                p-id="69893"
                width="20"
                height="20"
              >
                <path
                  d="M2.327273 1010.036364c-2.327273-11.636364-2.327273-41.890909 0-74.472728 6.981818-58.181818 30.254545-100.072727 65.163636-125.672727 25.6-18.618182 58.181818-27.927273 86.109091-34.909091 13.963636-2.327273 27.927273-6.981818 39.563636-9.309091 69.818182-16.290909 141.963636-32.581818 195.490909-102.4 4.654545-4.654545 32.581818-46.545455-41.890909-137.309091-32.581818-39.563636-53.527273-93.090909-62.836363-160.581818-9.309091-69.818182-2.327273-134.981818 4.654545-176.872727 9.309091-48.872727 37.236364-93.090909 79.127273-125.672727 41.890909-32.581818 93.090909-48.872727 144.290909-48.872728s102.4 16.290909 144.290909 48.872728c41.890909 32.581818 69.818182 76.8 79.127273 128 6.981818 41.890909 13.963636 107.054545 4.654545 176.872727-9.309091 65.163636-30.254545 118.690909-62.836363 160.581818-74.472727 90.763636-44.218182 132.654545-41.890909 137.309091 53.527273 72.145455 125.672727 88.436364 195.490909 102.4 13.963636 2.327273 27.927273 6.981818 41.890909 9.309091 25.6 6.981818 58.181818 16.290909 83.781818 34.909091 76.8 53.527273 69.818182 169.890909 67.490909 197.818182H2.327273z"
                  p-id="69894"
                  fill="#08C163"
                ></path>
              </svg>
            }
            title="我"
            key="me"
            selected={this.state.selectedTab === "/individual"}
            onPress={() => {
              this.setState(
                {
                  selectedTab: "/individual",
                  isIndividual: true
                },
                () => {
                  self.props.history.push("/individual");
                  self.props.getIsIndividual(this.state.isIndividual);
                }
              );
            }}
          ></TabBar.Item>
        </TabBar>
      </div>
    );
  }
}

export default withRouter(Tabbar);
